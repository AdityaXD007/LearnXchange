{% extends "base/base.html" %}
{% load static %}
{% block content %}
    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="container">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="page-title">My Sessions</h1>
                        <p class="page-description">Manage your learning sessions, requests, and bookings</p>
                    </div>
                    <a href="{% url 'matching' %}" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>
                        Find New Session
                    </a>
                </div>
            </div>
        </div>
        <div class="container">
            <!-- Session Tabs -->
            <div class="card mb-6">
                <div class="flex border-b border-gray-200">
                    <button onclick="showTab('upcoming')"
                            class="tab-button active"
                            id="upcomingTab">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Upcoming Sessions
                        <span class="ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">{{ upcoming_sessions.count }}</span>
                    </button>
                    <button onclick="showTab('requests')" class="tab-button" id="requestsTab">
                        <i class="fas fa-inbox mr-2"></i>
                        Requests
                        <span class="ml-2 bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">{{ received_requests.count }}</span>
                    </button>
                    <button onclick="showTab('history')" class="tab-button" id="historyTab">
                        <i class="fas fa-history mr-2"></i>
                        Session History
                    </button>
                    <button onclick="showTab('feedback')" class="tab-button" id="feedbackTab">
                        <i class="fas fa-star mr-2"></i>
                        Pending Feedback
                        <span class="ml-2 bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">{{ pending_feedback.count }}</span>
                    </button>
                </div>
            </div>
            <!-- Upcoming Sessions Tab -->
            <div id="upcomingContent" class="tab-content">
                <div class="space-y-4">
                    {% if today_sessions %}
                        <!-- Today's Sessions -->
                        <div class="card border-blue-200 bg-blue-50">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-blue-900">Today's Sessions</h3>
                                <span class="text-blue-600 text-sm">{{ today|date:"F d, Y" }}</span>
                            </div>
                            {% for session in today_sessions %}
                                <div class="bg-white rounded-lg p-4 border border-blue-200 mb-3">
                                    <div class="flex items-start gap-4">
                                        {% if session.teacher == request.user %}
                                            <img src="{% if session.student.profile.image %}{{ session.student.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                 alt="{{ session.student.profile.full_name|default:session.student.username }}"
                                                 class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <h4 class="font-semibold text-gray-900">{{ session.skill.name }}</h4>
                                                        <p class="text-gray-600 text-sm">
                                                            Teaching session with {{ session.student.profile.full_name|default:session.student.username }}
                                                        </p>
                                                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                                            <span><i class="fas fa-clock mr-1"></i>{{ session.scheduled_time|time:"g:i A" }} - {{ session.scheduled_time|date:"g:i A" }}</span>
                                                            <span><i class="fas fa-video mr-1"></i>Online</span>
                                                            <span><i class="fas fa-tag mr-1"></i>{{ session.duration }} minutes</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <button class="btn btn-success btn-sm"
                                                                onclick="joinSession({{ session.id }})">
                                                            <i class="fas fa-video mr-1"></i>
                                                            Join Meeting
                                                        </button>
                                                        <button onclick="rescheduleSession({{ session.id }})"
                                                                class="btn btn-outline btn-sm">
                                                            <i class="fas fa-calendar mr-1"></i>
                                                            Reschedule
                                                        </button>
                                                    </div>
                                                </div>
                                                {% if session.notes %}
                                                    <div class="mt-3 p-3 bg-gray-50 rounded">
                                                        <p class="text-sm text-gray-700">
                                                            <strong>Session Plan:</strong> {{ session.notes }}
                                                        </p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <img src="{% if session.teacher.profile.image %}{{ session.teacher.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                 alt="{{ session.teacher.profile.full_name|default:session.teacher.username }}"
                                                 class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <h4 class="font-semibold text-gray-900">{{ session.skill.name }}</h4>
                                                        <p class="text-gray-600 text-sm">
                                                            Learning session with {{ session.teacher.profile.full_name|default:session.teacher.username }}
                                                        </p>
                                                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                                            <span><i class="fas fa-clock mr-1"></i>{{ session.scheduled_time|time:"g:i A" }} - {{ session.scheduled_time|date:"g:i A" }}</span>
                                                            <span><i class="fas fa-video mr-1"></i>Online</span>
                                                            <span><i class="fas fa-tag mr-1"></i>{{ session.duration }} minutes</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <button class="btn btn-success btn-sm"
                                                                onclick="joinSession({{ session.id }})">
                                                            <i class="fas fa-video mr-1"></i>
                                                            Join Meeting
                                                        </button>
                                                        <button onclick="rescheduleSession({{ session.id }})"
                                                                class="btn btn-outline btn-sm">
                                                            <i class="fas fa-calendar mr-1"></i>
                                                            Reschedule
                                                        </button>
                                                    </div>
                                                </div>
                                                {% if session.notes %}
                                                    <div class="mt-3 p-3 bg-gray-50 rounded">
                                                        <p class="text-sm text-gray-700">
                                                            <strong>Session Plan:</strong> {{ session.notes }}
                                                        </p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <!-- Upcoming Sessions -->
                    {% if week_sessions %}
                        <div class="card">
                            <h3 class="font-semibold text-gray-900 mb-4">This Week</h3>
                            <div class="space-y-4">
                                {% for session in week_sessions %}
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-start gap-4">
                                            {% if session.teacher == request.user %}
                                                <img src="{% if session.student.profile.image %}{{ session.student.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                     alt="{{ session.student.profile.full_name|default:session.student.username }}"
                                                     class="w-12 h-12 rounded-full">
                                                <div class="flex-1">
                                                    <div class="flex items-center justify-between">
                                                        <div>
                                                            <h4 class="font-semibold text-gray-900">{{ session.skill.name }}</h4>
                                                            <p class="text-gray-600 text-sm">
                                                                Teaching session with {{ session.student.profile.full_name|default:session.student.username }}
                                                            </p>
                                                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                                                <span><i class="fas fa-calendar mr-1"></i>{{ session.scheduled_time|date:"M d" }}</span>
                                                                <span><i class="fas fa-clock mr-1"></i>{{ session.scheduled_time|time:"g:i A" }}</span>
                                                                <span><i class="fas fa-chalkboard-teacher mr-1"></i>Teaching</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <button onclick="sendMessage('{{ session.student.username }}')"
                                                                    class="btn btn-outline btn-sm">
                                                                <i class="fas fa-message mr-1"></i>
                                                                Message
                                                            </button>
                                                            <button onclick="prepareSession({{ session.id }})"
                                                                    class="btn btn-primary btn-sm">
                                                                <i class="fas fa-edit mr-1"></i>
                                                                Prepare
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <img src="{% if session.teacher.profile.image %}{{ session.teacher.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                     alt="{{ session.teacher.profile.full_name|default:session.teacher.username }}"
                                                     class="w-12 h-12 rounded-full">
                                                <div class="flex-1">
                                                    <div class="flex items-center justify-between">
                                                        <div>
                                                            <h4 class="font-semibold text-gray-900">{{ session.skill.name }}</h4>
                                                            <p class="text-gray-600 text-sm">
                                                                Learning session with {{ session.teacher.profile.full_name|default:session.teacher.username }}
                                                            </p>
                                                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                                                <span><i class="fas fa-calendar mr-1"></i>{{ session.scheduled_time|date:"M d" }}</span>
                                                                <span><i class="fas fa-clock mr-1"></i>{{ session.scheduled_time|time:"g:i A" }}</span>
                                                                <span><i class="fas fa-graduation-cap mr-1"></i>Learning</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-2">
                                                            <button onclick="sendMessage('{{ session.teacher.username }}')"
                                                                    class="btn btn-outline btn-sm">
                                                                <i class="fas fa-message mr-1"></i>
                                                                Message
                                                            </button>
                                                            <button onclick="rescheduleSession({{ session.id }})"
                                                                    class="btn btn-outline btn-sm">
                                                                <i class="fas fa-calendar mr-1"></i>
                                                                Reschedule
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    {% if not today_sessions and not week_sessions %}
                        <div id="noUpcomingSessions" class="text-center py-12">
                            <div class="text-gray-400 mb-4">
                                <i class="fas fa-calendar-times fa-3x"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No upcoming sessions</h3>
                            <p class="text-gray-600 mb-4">Ready to start learning? Find a session partner!</p>
                            <a href="{% url 'matching' %}" class="btn btn-primary">Find Learning Partners</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Requests Tab -->
            <div id="requestsContent" class="tab-content" style="display: none;">
                <div class="grid grid-2 gap-6">
                    <!-- Incoming Requests -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Incoming Requests</h3>
                            <span class="text-sm text-gray-600">People who want to learn from you</span>
                        </div>
                        <div class="space-y-4">
                            {% for request in received_requests %}
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-start gap-3">
                                        <div class="custom-avatar-container">
                                            <img src="{% if request.requester.profile.image %}{{ request.requester.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                alt="{{ request.requester.profile.full_name|default:request.requester.username }}"
                                                class="custom-avatar-image">
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="font-medium">{{ request.requester.profile.full_name|default:request.requester.username }}</h4>
                                                <span class="text-xs text-gray-500">{{ request.created_at|timesince }} ago</span>
                                            </div>
                                            <p class="text-sm text-gray-700 mb-2">
                                                Wants to learn <strong>{{ request.skill_to_learn }}</strong>
                                            </p>
                                            <p class="text-xs text-gray-600 mb-2">
                                                Offering <strong>{{ request.skill_to_teach }}</strong> in return
                                            </p>
                                            <p class="text-xs text-gray-600 mb-2">
                                                Session length: <strong>{{ request.session_length }} minutes</strong>
                                            </p>
                                            {% if request.message %}<p class="text-xs text-gray-600 mb-3">"{{ request.message|truncatechars:100 }}"</p>{% endif %}
                                            {% if request.status == 'pending' %}
                                                <div class="flex gap-2">
                                                    <form method="post"
                                                          action="{% url 'handle_session_request' request.id %}"
                                                          class="inline">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="accept">
                                                        <button type="submit" class="btn btn-success btn-sm">
                                                            <i class="fas fa-check mr-1"></i>
                                                            Accept
                                                        </button>
                                                    </form>
                                                    <form method="post"
                                                          action="{% url 'handle_session_request' request.id %}"
                                                          class="inline">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="decline">
                                                        <button type="submit" class="btn btn-danger btn-sm">
                                                            <i class="fas fa-times mr-1"></i>
                                                            Decline
                                                        </button>
                                                    </form>
                                                    <button onclick="sendMessage('{{ request.requester.username }}')"
                                                            class="btn btn-outline btn-sm">
                                                        <i class="fas fa-message mr-1"></i>
                                                        Message
                                                    </button>
                                                </div>
                                            {% else %}
                                                <span class="inline-block px-2 py-1 text-xs rounded-full {% if request.status == 'accepted' %}bg-green-100 text-green-800 {% elif request.status == 'declined' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ request.get_status_display }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center py-8">
                                    <div class="text-gray-400 mb-2">
                                        <i class="fas fa-inbox fa-2x"></i>
                                    </div>
                                    <p class="text-gray-600">No incoming requests</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Outgoing Requests -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Outgoing Requests</h3>
                            <span class="text-sm text-gray-600">Your requests to learn from others</span>
                        </div>
                        <div class="space-y-4">
                            {% for request in sent_requests %}
                                <div class="border {% if request.status == 'pending' %}border-yellow-200 bg-yellow-50 {% elif request.status == 'accepted' %}border-green-200 bg-green-50 {% elif request.status == 'declined' %}border-red-200 bg-red-50 {% else %}border-gray-200{% endif %} rounded-lg p-4">
                                    <div class="flex items-start gap-3">
                                        <!-- Custom avatar container with unique ID -->
                                        <div id="avatar-container-{{ request.id }}" class="custom-avatar-container">
                                            <img src="{% if request.partner.profile.image %}{{ request.partner.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                alt="{{ request.partner.profile.full_name|default:request.partner.username }}"
                                                class="custom-avatar-image">
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="font-medium">{{ request.partner.profile.full_name|default:request.partner.username }}</h4>
                                                <span class="px-2 py-1 rounded text-xs {% if request.status == 'pending' %}bg-yellow-100 text-yellow-800 {% elif request.status == 'accepted' %}bg-green-100 text-green-800 {% elif request.status == 'declined' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ request.get_status_display }}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-700 mb-2">
                                                You want to learn <strong>{{ request.skill_to_learn }}</strong>
                                            </p>
                                            <p class="text-xs text-gray-600 mb-3">
                                                Sent {{ request.created_at|timesince }} ago • Offering {{ request.skill_to_teach }} in return
                                            </p>
                                            <div class="flex gap-2">
                                                {% if request.status == 'pending' %}
                                                    <form method="post"
                                                            action="{% url 'cancel_session_request' request.id %}"
                                                            class="inline">
                                                        {% csrf_token %}
                                                        <button type="submit"
                                                                class="btn btn-outline btn-sm"
                                                                onclick="return confirm('Are you sure you want to cancel this request?')">
                                                            <i class="fas fa-times mr-1"></i>
                                                            Cancel Request
                                                        </button>
                                                    </form>
                                                {% elif request.status == 'accepted' %}
                                                    <button onclick="viewSession({{ request.id }})"
                                                            class="btn btn-primary btn-sm">
                                                        <i class="fas fa-calendar mr-1"></i>
                                                        View Session
                                                    </button>
                                                {% elif request.status == 'declined' %}
                                                    <button onclick="findAlternative('{{ request.skill_to_learn }}')"
                                                            class="btn btn-primary btn-sm">
                                                        <i class="fas fa-search mr-1"></i>
                                                        Find Alternative
                                                    </button>
                                                {% endif %}
                                                <button onclick="sendMessage('{{ request.partner.username }}')"
                                                        class="btn btn-outline btn-sm">
                                                    <i class="fas fa-message mr-1"></i>
                                                    View Profile
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center py-8">
                                    <div class="text-gray-400 mb-2">
                                        <i class="fas fa-paper-plane fa-2x"></i>
                                    </div>
                                    <p class="text-gray-600">No outgoing requests</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Session History Tab -->
            <div id="historyContent" class="tab-content" style="display: none;">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-semibold text-gray-900">Session History</h3>
                        <div class="flex gap-3">
                            <form method="GET" class="flex gap-3">
                                <select name="filter"
                                        class="form-input form-select"
                                        style="width: auto"
                                        onchange="this.form.submit()">
                                    <option value="all" {% if request.GET.filter == 'all' %}selected{% endif %}>All Sessions</option>
                                    <option value="completed"
                                            {% if request.GET.filter == 'completed' %}selected{% endif %}>
                                        Completed
                                    </option>
                                    <option value="cancelled"
                                            {% if request.GET.filter == 'cancelled' %}selected{% endif %}>
                                        Cancelled
                                    </option>
                                    <option value="teaching"
                                            {% if request.GET.filter == 'teaching' %}selected{% endif %}>
                                        Teaching
                                    </option>
                                    <option value="learning"
                                            {% if request.GET.filter == 'learning' %}selected{% endif %}>
                                        Learning
                                    </option>
                                </select>
                                <select name="sort"
                                        class="form-input form-select"
                                        style="width: auto"
                                        onchange="this.form.submit()">
                                    <option value="recent"
                                            {% if request.GET.sort == 'recent' %}selected{% endif %}>
                                        Most Recent
                                    </option>
                                    <option value="oldest"
                                            {% if request.GET.sort == 'oldest' %}selected{% endif %}>
                                        Oldest First
                                    </option>
                                    <option value="rating"
                                            {% if request.GET.sort == 'rating' %}selected{% endif %}>
                                        Highest Rated
                                    </option>
                                </select>
                            </form>
                        </div>
                    </div>
                    <div class="space-y-4">
                        {% for session in session_history %}
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start gap-4">
                                    {% if session.teacher == request.user %}
                                        {% with partner=session.student partner_rating=session.rating_by_student %}
                                            <img src="{% if partner.profile.image %}{{ partner.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                 alt="{{ partner.profile.full_name|default:partner.username }}"
                                                 class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <h4 class="font-semibold text-gray-900">{{ session.skill.name }}</h4>
                                                        <p class="text-gray-600 text-sm">Teaching session with {{ partner.profile.full_name|default:partner.username }}</p>
                                                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                                            <span><i class="fas fa-calendar mr-1"></i>{{ session.scheduled_time|date:"F j, Y" }}</span>
                                                            <span><i class="fas fa-clock mr-1"></i>{{ session.duration }} minutes</span>
                                                            <span class="px-2 py-1 rounded text-xs {% if session.status == 'completed' %}bg-green-100 text-green-800 {% elif session.status == 'cancelled' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                                <i class="fas fa-{% if session.status == 'completed' %}check{% elif session.status == 'cancelled' %}times{% else %}clock{% endif %} mr-1"></i>
                                                                {{ session.get_status_display }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        {% if partner_rating %}
                                                            <div class="flex items-center mb-2">
                                                                {% for i in "12345" %}
                                                                    {% if forloop.counter <= partner_rating %}
                                                                        <i class="fas fa-star text-yellow-400 text-sm"></i>
                                                                    {% else %}
                                                                        <i class="fas fa-star text-gray-300 text-sm"></i>
                                                                    {% endif %}
                                                                {% endfor %}
                                                                <span class="ml-1 text-sm text-gray-600">{{ partner_rating }}.0</span>
                                                            </div>
                                                        {% endif %}
                                                        {% if session.status == 'completed' %}
                                                            <button onclick="bookAgain('{{ partner.username }}')"
                                                                    class="btn btn-primary btn-sm">
                                                                <i class="fas fa-redo mr-1"></i>
                                                                Book Again
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endwith %}
                                    {% else %}
                                        {% with partner=session.teacher partner_rating=session.rating_by_teacher %}
                                            <img src="{% if partner.profile.image %}{{ partner.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                 alt="{{ partner.profile.full_name|default:partner.username }}"
                                                 class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <h4 class="font-semibold text-gray-900">{{ session.skill.name }}</h4>
                                                        <p class="text-gray-600 text-sm">Learning session with {{ partner.profile.full_name|default:partner.username }}</p>
                                                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                                                            <span><i class="fas fa-calendar mr-1"></i>{{ session.scheduled_time|date:"F j, Y" }}</span>
                                                            <span><i class="fas fa-clock mr-1"></i>{{ session.duration }} minutes</span>
                                                            <span class="px-2 py-1 rounded text-xs {% if session.status == 'completed' %}bg-green-100 text-green-800 {% elif session.status == 'cancelled' %}bg-red-100 text-red-800 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                                <i class="fas fa-{% if session.status == 'completed' %}check{% elif session.status == 'cancelled' %}times{% else %}clock{% endif %} mr-1"></i>
                                                                {{ session.get_status_display }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        {% if partner_rating %}
                                                            <div class="flex items-center mb-2">
                                                                {% for i in "12345" %}
                                                                    {% if forloop.counter <= partner_rating %}
                                                                        <i class="fas fa-star text-yellow-400 text-sm"></i>
                                                                    {% else %}
                                                                        <i class="fas fa-star text-gray-300 text-sm"></i>
                                                                    {% endif %}
                                                                {% endfor %}
                                                                <span class="ml-1 text-sm text-gray-600">{{ partner_rating }}.0</span>
                                                            </div>
                                                        {% endif %}
                                                        {% if session.status == 'completed' %}
                                                            <button onclick="bookAgain('{{ partner.username }}')"
                                                                    class="btn btn-primary btn-sm">
                                                                <i class="fas fa-redo mr-1"></i>
                                                                Book Again
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endwith %}
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-12">
                                <div class="text-gray-400 mb-4">
                                    <i class="fas fa-history fa-3x"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">No session history yet</h3>
                                <p class="text-gray-600 mb-4">Complete your first session to see it here!</p>
                            </div>
                        {% endfor %}
                    </div>
                    {% if session_history.has_next %}
                        <div class="text-center py-8">
                            <a href="?page={{ session_history.next_page_number }}"
                               class="btn btn-outline">
                                <i class="fas fa-chevron-down mr-2"></i>
                                Load More Sessions
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Pending Feedback Tab -->
            <div id="feedbackContent" class="tab-content" style="display: none;">
                <div class="card">
                    <h3 class="font-semibold text-gray-900 mb-6">Sessions Awaiting Feedback</h3>
                    <div class="space-y-6">
                        {% for session in pending_feedback %}
                            <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-6">
                                <div class="flex items-start gap-4">
                                    {% if session.teacher == request.user %}
                                        {% with partner=session.student %}
                                            <img src="{% if partner.profile.image %}{{ partner.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                 alt="{{ partner.profile.full_name|default:partner.username }}"
                                                 class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <h4 class="font-semibold text-gray-900 mb-2">{{ session.skill.name }}</h4>
                                                <p class="text-gray-600 text-sm mb-4">
                                                    Teaching session with {{ partner.profile.full_name|default:partner.username }}
                                                    • Completed {{ session.scheduled_time|timesince }} ago
                                                </p>
                                                <form method="POST"
                                                      action="{% url 'submit_feedback' session.id %}"
                                                      class="space-y-4">
                                                    {% csrf_token %}
                                                    <div>
                                                        <label class="form-label">Rate your session</label>
                                                        <div class="flex items-center gap-1">
                                                            {% for i in "12345" %}
                                                                <button type="button"
                                                                        onclick="setRating({{ session.id }}, {{ forloop.counter }})"
                                                                        class="star-rating"
                                                                        data-session="{{ session.id }}"
                                                                        data-rating="{{ forloop.counter }}">
                                                                    <i class="fas fa-star text-gray-300"></i>
                                                                </button>
                                                            {% endfor %}
                                                        </div>
                                                        <input type="hidden" name="rating" id="rating-{{ session.id }}" required>
                                                    </div>
                                                    <div>
                                                        <label class="form-label">Share your experience</label>
                                                        <textarea name="feedback"
                                                                  class="form-input form-textarea"
                                                                  placeholder="How was your teaching experience? What did you like most?"
                                                                  required></textarea>
                                                    </div>
                                                    <div class="flex gap-3">
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="fas fa-paper-plane mr-1"></i>
                                                            Submit Feedback
                                                        </button>
                                                        <button type="button"
                                                                onclick="skipFeedback({{ session.id }})"
                                                                class="btn btn-outline">Skip for now</button>
                                                    </div>
                                                </form>
                                            </div>
                                        {% endwith %}
                                    {% else %}
                                        {% with partner=session.teacher %}
                                            <img src="{% if partner.profile.image %}{{ partner.profile.image.url }}{% else %}{% static 'assets/default-avatar.png' %}{% endif %}"
                                                 alt="{{ partner.profile.full_name|default:partner.username }}"
                                                 class="w-12 h-12 rounded-full">
                                            <div class="flex-1">
                                                <h4 class="font-semibold text-gray-900 mb-2">{{ session.skill.name }}</h4>
                                                <p class="text-gray-600 text-sm mb-4">
                                                    Learning session with {{ partner.profile.full_name|default:partner.username }}
                                                    • Completed {{ session.scheduled_time|timesince }} ago
                                                </p>
                                                <form method="POST"
                                                      action="{% url 'submit_feedback' session.id %}"
                                                      class="space-y-4">
                                                    {% csrf_token %}
                                                    <div>
                                                        <label class="form-label">Rate your session</label>
                                                        <div class="flex items-center gap-1">
                                                            {% for i in "12345" %}
                                                                <button type="button"
                                                                        onclick="setRating({{ session.id }}, {{ forloop.counter }})"
                                                                        class="star-rating"
                                                                        data-session="{{ session.id }}"
                                                                        data-rating="{{ forloop.counter }}">
                                                                    <i class="fas fa-star text-gray-300"></i>
                                                                </button>
                                                            {% endfor %}
                                                        </div>
                                                        <input type="hidden" name="rating" id="rating-{{ session.id }}" required>
                                                    </div>
                                                    <div>
                                                        <label class="form-label">Share your experience</label>
                                                        <textarea name="feedback"
                                                                  class="form-input form-textarea"
                                                                  placeholder="How was your learning experience? What did you like most?"
                                                                  required></textarea>
                                                    </div>
                                                    <div class="flex gap-3">
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="fas fa-paper-plane mr-1"></i>
                                                            Submit Feedback
                                                        </button>
                                                        <button type="button"
                                                                onclick="skipFeedback({{ session.id }})"
                                                                class="btn btn-outline">Skip for now</button>
                                                    </div>
                                                </form>
                                            </div>
                                        {% endwith %}
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center py-12">
                                <div class="text-gray-400 mb-4">
                                    <i class="fas fa-star fa-3x"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">All caught up!</h3>
                                <p class="text-gray-600">No sessions awaiting feedback.</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </main>
        <style>
            
    .custom-avatar-container {
        width: 140px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        background-color: #f3f4f6;
    }
    
    .custom-avatar-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    
        </style>
        <script>
// Updated JavaScript functions for sessions.html template
// Replace the existing script section in your sessions.html with this

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });

    // Hide the no sessions message specifically
    const noSessionsMsg = document.getElementById('noUpcomingSessions');
    if (noSessionsMsg) {
        noSessionsMsg.style.display = 'none';
    }

    // Remove active class from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });

    // Show selected tab content and add active class
    document.getElementById(tabName + 'Content').style.display = 'block';
    document.getElementById(tabName + 'Tab').classList.add('active');

    // Show no sessions message only for upcoming tab when appropriate
    if (tabName === 'upcoming' && noSessionsMsg) {
        noSessionsMsg.style.display = 'block';
    }
}

function rescheduleSession(sessionId) {
    if (confirm('Would you like to reschedule this session?')) {
        // Use Django's URL template tag properly
        const url = "{% url 'reschedule_session' 0 %}".replace('0', sessionId);
        window.location.href = url;
    }
}

function prepareSession(sessionId) {
    // Use Django's URL template tag properly
    const url = "{% url 'prepare_session' 0 %}".replace('0', sessionId);
    window.location.href = url;
}

function sendMessage(username) {
    // For now, redirect to user profile since messaging isn't implemented
    const url = "{% url 'user_profile' 'placeholder' %}".replace('placeholder', username);
    window.location.href = url;
}

function viewSession(requestId) {
    // Since this view doesn't exist yet, redirect to sessions page
    alert('Session details view coming soon!');
    // window.location.href = "{% url 'sessions' %}";
}

function findAlternative(skillName) {
    // Redirect to matching with skill filter
    window.location.href = `{% url 'matching' %}?skill_filter=${encodeURIComponent(skillName)}`;
}

function bookAgain(username) {
    // Redirect to user profile
    const url = "{% url 'user_profile' 'placeholder' %}".replace('placeholder', username);
    window.location.href = url;
}

function joinSession(sessionId) {
    // Placeholder for video call functionality
    alert('Video call feature coming soon! Please contact your partner directly for now.');
}

function setRating(sessionId, rating) {
    // Update visual stars
    const sessionRatings = document.querySelectorAll(`[data-session="${sessionId}"]`);
    sessionRatings.forEach((star, index) => {
        const icon = star.querySelector('i');
        if (index < rating) {
            icon.className = 'fas fa-star text-yellow-400';
        } else {
            icon.className = 'fas fa-star text-gray-300';
        }
    });
    
    // Set hidden input value
    const ratingInput = document.getElementById(`rating-${sessionId}`);
    if (ratingInput) {
        ratingInput.value = rating;
    }
}

function skipFeedback(sessionId) {
    if (confirm('Skip feedback for this session? You can provide it later from your session history.')) {
        // Make AJAX call to mark feedback as skipped
        fetch(`{% url 'skip_feedback' 0 %}`.replace('0', sessionId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error skipping feedback. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error skipping feedback. Please try again.');
        });
    }
}

// Add styles for tab buttons
const style = document.createElement('style');
style.textContent = `
    .tab-button {
        padding: 12px 24px;
        border: none;
        background: none;
        color: #6b7280;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }
    .tab-button:hover {
        color: #3b82f6;
    }
    .tab-button.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    .star-rating {
        background: none;
        border: none;
        cursor: pointer;
        padding: 2px;
    }
    .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    @media (max-width: 768px) {
        .grid-2 {
            grid-template-columns: 1fr;
        }
    }
`;
document.head.appendChild(style);

// Auto-refresh pending feedback count (optional)
setInterval(function() {
    // Optional: Auto-refresh to check for new requests/sessions
    // This could be replaced with WebSocket connections for real-time updates
}, 300000); // 5 minutes
        </script>
    {% endblock content %}
